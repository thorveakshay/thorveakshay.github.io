{% if site.google_analytics %}
<!-- Asynchronous Google Analytics snippet -->
<script>
  var _gaq = _gaq || [];
  var pluginUrl =
    '//www.google-analytics.com/plugins/ga/inpage_linkid.js';
  _gaq.push(['_require', 'inpage_linkid', pluginUrl]);
  _gaq.push(['_setAccount', '{{ site.google_analytics }}']);
  _gaq.push(['_trackPageview']);

  (function () {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://' : 'http://') + 'stats.g.doubleclick.net/dc.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>
{% endif %}

<!-- gist embed -->
{% if page.gistembed %}
{% include gist_embed.html %}
{% endif %}

<!-- disqus comments -->
{% if page.comments %}{% include disqus_comments.html %}{% endif %}

<!-- MermaidJS support -->
<script type="module">
  import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';

  // Configure mermaid
  mermaid.initialize({
    startOnLoad: false,
    theme: 'default'
  });

  document.addEventListener('DOMContentLoaded', async function () {
    // 1. Find all standard Jekyll code blocks marked as mermaid
    // usually <div class="language-mermaid ..."> or <pre><code class="language-mermaid">
    const codeBlocks = document.querySelectorAll('.language-mermaid');

    // 2. Also check for raw pre>code patterns just in case
    const rawBlocks = document.querySelectorAll('pre code.language-mermaid');

    const allBlocks = [...codeBlocks, ...rawBlocks];

    if (allBlocks.length === 0) return;

    // Helper to process a block
    allBlocks.forEach(block => {
      // Avoid processing twice if we caught nested elements
      if (block.closest('.mermaid-processed')) return;

      // Get the code content
      // If it's a wrapper div, textContent is usually fine.
      let code = block.textContent;

      // Create new mermaid div
      let div = document.createElement('div');
      div.className = 'mermaid';
      div.textContent = code;

      // Create a marker to prevent double processing
      div.classList.add('mermaid-processed');

      // Replace the block
      // If it's a code element, try to replace the pre wrapper
      if (block.tagName === 'CODE' && block.parentElement.tagName === 'PRE') {
        block.parentElement.replaceWith(div);
      } else {
        // Otherwise replace the block itself (likely the div wrapper)
        block.replaceWith(div); // This replaces the .language-mermaid div
      }
    });

    // 3. Remove the processed marker class before rendering so mermaid doesn't get confused
    document.querySelectorAll('.mermaid-processed').forEach(el => el.classList.remove('mermaid-processed'));

    // 4. Run mermaid
    await mermaid.run({
      nodes: document.querySelectorAll('.mermaid')
    });
  });
</script>